<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freelancerrr - Simple Frontend</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- NEW: Include Socket.IO Client Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #e2e8f0; /* Lighter grey-blue background */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container {
            max-width: 1280px; /* Increased from 1024px for more distributed space */
            margin: 0 auto;
            padding: 1.5rem;
            flex-grow: 1;
            display: flex; /* Always a flex container */
            flex-direction: column; /* Always a column */
            align-items: center; /* Always horizontally center children within the column */
            justify-content: flex-start; /* Default: Align content to the top */
        }
        /* New class to apply for vertical centering of main's content */
        .container.center-content {
            justify-content: center; /* Override to center vertically */
        }

        .message-box {
            background-color: #fff3e0; /* Light orange for warning/info */
            border: 1px solid #ffcc80;
            color: #e65100;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            width: 100%; /* Ensure it spans the width */
            max-width: 600px; /* Limit width for better readability */
            margin-left: auto;
            margin-right: auto;
        }
        .message-box.error {
            background-color: #ffebee; /* Light red for error */
            border-color: #ef9a9a;
            color: #c62828;
        }
        .message-box.success {
            background-color: #e8f5e9; /* Light green for success */
            border-color: #a5d6a7;
            color: #2e7d32;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            color: #4b5563;
            z-index: 1000;
        }
        /* Custom styles for glowing buttons */
        .glow-button {
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .glow-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15), 0 3px 6px rgba(0, 0, 0, 0.1);
        }
        .glow-button.bg-indigo-600:hover {
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.7); /* Indigo glow */
        }
        .glow-button.bg-red-500:hover {
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.7); /* Red glow */
        }
        .glow-button.bg-green-600:hover {
            box-shadow: 0 0 15px rgba(52, 211, 153, 0.7); /* Green glow */
        }
        .glow-button.bg-blue-600:hover {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.7); /* Blue glow */
        }
        .glow-button.bg-purple-600:hover {
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.7); /* Purple glow */
        }
        .glow-button.bg-yellow-600:hover {
            box-shadow: 0 0 15px rgba(250, 204, 21, 0.7); /* Yellow glow */
        }

        /* Specific styles for messages view */
        #messages-content-area {
            display: flex;
            flex-direction: column;
            height: 100%; /* Make messages section fill available height */
        }
        #chat-messages-container {
            flex-grow: 1; /* Allow chat messages to take up available space */
            overflow-y: auto; /* Enable scrolling for messages */
            padding: 1rem;
            background-color: #f8fafc; /* Light grey background for chat */
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            margin-bottom: 1rem;
            display: flex; /* Make it a flex container for messages */
            flex-direction: column; /* Stack messages vertically */
            max-height: 500px; /* Limit height for message history */
        }
        .message-item {
            background-color: #fff;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            max-width: 90%;
            align-self: flex-start; /* Default for general messages */
            word-wrap: break-word; /* Ensure long words wrap */
            overflow-wrap: break-word; /* Ensure long words wrap */
        }
        .message-item.sent-by-me {
            background-color: #e0f2f7; /* Light blue for messages sent by current user */
            align-self: flex-end; /* Align to the right */
        }
        .message-item strong {
            color: #4a5568; /* Darker grey for sender name/time */
        }
    </style>
</head>
<body>
    <header class="w-full bg-gradient-to-r from-indigo-700 to-indigo-500 shadow-xl p-4 flex flex-col sm:flex-row justify-between items-center rounded-b-xl">
        <h1 class="text-4xl font-extrabold text-white mb-3 sm:mb-0 sm:text-left">Freelancerrr</h1>
        <nav id="navbar" class="flex flex-wrap justify-center sm:justify-end items-center space-x-2 sm:space-x-4">
            <!-- Navigation buttons will be rendered here by JS -->
        </nav>
    </header>

    <main class="container p-6">
        <!-- Loading overlay remains outside content div -->
        <div id="loading" class="loading-overlay hidden">
            <p>Loading...</p>
        </div>
        <div id="content" class="w-full">
            <!-- Dynamic content will be rendered here by JS -->
        </div>
    </main>

    <footer class="w-full bg-gray-800 text-white p-4 text-center text-sm mt-auto">
        Made by Abdullah Adnan, Roll number: L1F23BSCS1247
    </footer>

    <script>
        // IMPORTANT: Replace with the actual URL where your Flask backend is running.
        const API_BASE_URL = 'https://freelancer-backend-rahz.onrender.com/api';
        // NEW: Base URL for WebSocket connection (should be your backend's root URL)
        const SOCKET_IO_SERVER_URL = 'https://freelancer-backend-rahz.onrender.com';


        let currentUser = null; // Stores logged-in user data
        let currentView = 'auth'; // 'auth', 'dashboard', 'createGig', 'gigList', 'gigDetail', 'myOrders', 'messages', 'reviews'
        let selectedGig = null; // For gigDetail view
        let selectedOrder = null; // For messages/reviews view

        // NEW: Socket.IO client instance
        let socket = null;

        // --- Utility Functions ---

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function showMessage(msg, type = 'info') {
            const messageBox = document.createElement('div');
            messageBox.className = `message-box ${type}`;
            messageBox.textContent = msg;
            const mainContainer = document.querySelector('main');
            // Remove any existing message boxes before adding a new one
            document.querySelectorAll('.message-box').forEach(box => box.remove());
            if (mainContainer) {
                // Insert message box at the top of the main content area
                mainContainer.insertBefore(messageBox, mainContainer.firstChild);
            } else {
                document.body.prepend(messageBox); // Fallback if main not found
            }
            setTimeout(() => messageBox.remove(), 5000); // Remove after 5 seconds
        }

        async function fetchAPI(endpoint, method = 'GET', body = null) {
            showLoading(true);
            try {
                const options = { method: method };
                if (body) {
                    options.headers = { 'Content-Type': 'application/json' };
                    options.body = JSON.stringify(body);
                }
                console.log(`Sending ${method} request to: ${API_BASE_URL}${endpoint}`);
                console.log('Request body:', body);

                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                const data = await response.json();
                
                if (!response.ok) {
                    console.error('API response not OK:', response.status, data);
                    throw new Error(data.message || `HTTP error! status: ${response.status}`);
                }
                console.log('API response success:', data);
                return data;
            } catch (error) {
                console.error(`API Error on ${endpoint}:`, error);
                showMessage(`Error: ${error.message}. Make sure your backend is running.`, 'error');
                throw error; // Re-throw to be caught by specific view handlers
            } finally {
                showLoading(false);
            }
        }

        // --- Navigation and View Rendering ---

        function navigateTo(view, data = null) {
            // NEW: If changing view from messages, disconnect from Socket.IO room
            if (currentView === 'messages' && socket && selectedOrder) {
                socket.emit('leave_order_room', { order_id: selectedOrder.id }); // Assuming you add this backend event handler
                console.log(`Left order room: ${selectedOrder.id}`);
            }

            currentView = view;
            selectedGig = null;
            selectedOrder = null;
            if (view === 'gigDetail') {
                selectedGig = data;
            } else if (view === 'messages' || view === 'reviews') {
                selectedOrder = data;
            }
            render();
        }

        function renderNavbar() {
            const navbar = document.getElementById('navbar');
            navbar.innerHTML = ''; // Clear existing buttons

            if (currentUser) {
                const userInfoContainer = document.createElement('div');
                userInfoContainer.className = 'flex flex-col sm:flex-row items-center space-y-1 sm:space-y-0 sm:space-x-4 mb-2 sm:mb-0';

                const userIdSpan = document.createElement('span');
                userIdSpan.className = 'text-white text-sm font-light';
                userIdSpan.textContent = `User ID: ${currentUser.user_id}`;
                userInfoContainer.appendChild(userIdSpan);

                const roleSpan = document.createElement('span');
                roleSpan.className = 'text-white text-sm capitalize font-medium';
                roleSpan.textContent = `Role: ${currentUser.user_type}`;
                userInfoContainer.appendChild(roleSpan);
                navbar.appendChild(userInfoContainer);


                const dashboardBtn = createButton('Dashboard', () => navigateTo('dashboard'), 'bg-indigo-700 hover:bg-indigo-800');
                navbar.appendChild(dashboardBtn);

                if (currentUser.user_type === 'freelancer') {
                    const createGigBtn = createButton('Create Gig', () => navigateTo('createGig'), 'bg-indigo-700 hover:bg-indigo-800');
                    navbar.appendChild(createGigBtn);
                }
                if (currentUser.user_type === 'buyer') {
                    const browseGigsBtn = createButton('Browse Gigs', () => navigateTo('gigList'), 'bg-indigo-700 hover:bg-indigo-800');
                    navbar.appendChild(browseGigsBtn);
                }
                const myOrdersBtn = createButton('My Orders', () => navigateTo('myOrders'), 'bg-indigo-700 hover:bg-indigo-800');
                navbar.appendChild(myOrdersBtn);

                const logoutBtn = createButton('Logout', logout, 'bg-red-500 hover:bg-red-600');
                navbar.appendChild(logoutBtn);
            }
        }

        function createButton(text, onClickHandler, className) {
            const button = document.createElement('button');
            button.textContent = text;
            button.className = `${className} text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out glow-button`;
            button.onclick = onClickHandler;
            return button;
        }

        async function render() { 
            renderNavbar();
            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = ''; // Clear previous content
            const mainContainer = document.querySelector('main.container');

            // Reset flex properties on mainContainer and contentDiv for each render
            mainContainer.classList.remove('center-content');
            contentDiv.classList.remove('flex', 'flex-col', 'items-center', 'justify-center', 'flex-grow');

            if (currentView === 'auth') {
                mainContainer.classList.add('center-content'); // Centers #content within main vertically
                // Make #content fill space and internally center its child (the auth form)
                contentDiv.classList.add('flex', 'flex-col', 'items-center', 'justify-center', 'flex-grow'); 
            }

            switch (currentView) {
                case 'auth':
                    await renderAuth();
                    break;
                case 'dashboard':
                    renderDashboard(); // No AWAIT needed as it's not async
                    break;
                case 'createGig':
                    await renderCreateGig();
                    break;
                case 'gigList':
                    await renderGigList();
                    break;
                case 'gigDetail':
                    await renderGigDetail();
                    break;
                case 'myOrders':
                    await renderMyOrders();
                    break;
                case 'messages':
                    await renderMessages();
                    break;
                case 'reviews':
                    await renderReviews();
                    break;
                default:
                    await renderAuth();
            }
        }

        // --- Specific View Renderers ---

        async function renderAuth() {
            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md border border-indigo-200">
                    <h2 id="auth-title" class="text-3xl font-bold text-center text-indigo-700 mb-8">Login</h2>
                    <form id="auth-form" class="space-y-6">
                        <div id="name-field" class="hidden">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="name">Name</label>
                            <input type="text" id="name" class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-800 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="email">Email</label>
                            <input type="email" id="email" class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-800 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="password">Password</label>
                            <input type="password" id="password" class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-800 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200">
                        </div>
                        <div id="user-type-field" class="hidden">
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="userType">I am a:</label>
                            <select id="userType" class="block appearance-none w-full bg-white border border-gray-300 text-gray-800 py-3 px-4 pr-8 rounded-lg shadow-sm leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200">
                                <option value="freelancer">Freelancer</option>
                                <option value="buyer">Buyer</option>
                            </select>
                        </div>
                        <button type="submit" id="auth-submit-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline glow-button">Login</button>
                    </form>
                    <p class="mt-8 text-center text-gray-600 text-sm">
                        Don't have an account? <button id="toggle-auth-mode" class="text-indigo-600 hover:text-indigo-800 font-bold transition duration-200">Register here</button>
                    </p>
                </div>
            `;

            let isLoginMode = true;
            const authTitle = document.getElementById('auth-title');
            const nameField = document.getElementById('name-field');
            const userTypeField = document.getElementById('user-type-field');
            const authSubmitBtn = document.getElementById('auth-submit-btn');
            const toggleAuthModeBtn = document.getElementById('toggle-auth-mode');
            const authForm = document.getElementById('auth-form');

            const toggleAuthMode = (e) => {
                if (e) e.stopPropagation();
                isLoginMode = !isLoginMode;
                authTitle.textContent = isLoginMode ? 'Login' : 'Register';
                authSubmitBtn.textContent = isLoginMode ? 'Login' : 'Register';
                toggleAuthModeBtn.textContent = isLoginMode ? 'Register here' : 'Login here';
                nameField.classList.toggle('hidden', isLoginMode);
                userTypeField.classList.toggle('hidden', isLoginMode);
                console.log(`Switched to ${isLoginMode ? 'Login' : 'Register'} mode.`);
            };

            toggleAuthModeBtn.onclick = toggleAuthMode;

            authForm.onsubmit = async (e) => {
                debugger;
                e.preventDefault();
                console.log('Auth form submitted.');

                const name = document.getElementById('name').value;
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const userType = document.getElementById('userType').value;

                console.log('Captured form values:', { name, email, password, userType, isLoginMode });

                if (!email || !password || (!isLoginMode && !name)) {
                    showMessage('Please fill in all fields.', 'error');
                    console.log('Validation failed: Missing fields.');
                    return;
                }

                try {
                    let data;
                    if (isLoginMode) {
                        console.log('Calling API for login...');
                        data = await fetchAPI('/login', 'POST', { email, password });
                        if (data.user) {
                            currentUser = data.user;
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            showMessage(data.message, 'success');
                            console.log('Login successful, navigating to dashboard.');
                            navigateTo('dashboard');
                        } else {
                            // Specific error message for login failure
                            showMessage('Wrong username or password', 'error'); 
                            console.log('Login failed based on API response.');
                        }
                    } else {
                        console.log('Calling API for registration...');
                        data = await fetchAPI('/register', 'POST', { name, email, password, user_type: userType });
                        if (data.user) {
                            currentUser = data.user;
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            showMessage(data.message, 'success');
                            console.log('Registration successful, navigating to dashboard.');
                            navigateTo('dashboard');
                        } else {
                            showMessage(data.message || 'Registration failed.', 'error');
                            console.log('Registration failed based on API response.');
                        }
                    }
                } catch (error) {
                    console.error('Error during auth API call:', error);
                    // Error message already shown by fetchAPI
                }
            };
        }

        async function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showMessage('Logged out successfully.', 'success');
            navigateTo('auth');
        }

        function renderDashboard() {
            if (!currentUser) {
                navigateTo('auth');
                return;
            }

            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-2xl w-full border border-indigo-200">
                    <h2 class="text-3xl font-bold text-center text-indigo-700 mb-8">Welcome, <span class="text-indigo-900">${currentUser.name}!</span></h2>
                    <p class="text-center text-gray-700 text-lg mb-10">
                        You are logged in as a <span class="font-semibold capitalize text-indigo-600">${currentUser.user_type}</span>.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mx-auto max-w-fit">
                        ${currentUser.user_type === 'freelancer' ? `
                            <div class="bg-blue-50 p-8 rounded-xl shadow-lg flex flex-col items-center justify-center text-center border border-blue-200">
                                <h3 class="text-xl font-bold text-blue-700 mb-3">Your Gigs</h3>
                                <p class="text-gray-600 mb-6">Manage and create your freelance services.</p>
                                <button id="create-gig-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg glow-button">
                                    Create New Gig
                                </button>
                            </div>
                        ` : ''}
                        ${currentUser.user_type === 'buyer' ? `
                            <div class="bg-green-50 p-8 rounded-xl shadow-lg flex flex-col items-center justify-center text-center border border-green-200">
                                <h3 class="text-xl font-bold text-green-700 mb-3">Find Gigs</h3>
                                <p class="text-gray-600 mb-6">Explore services offered by freelancers.</p>
                                <button id="browse-gigs-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg glow-button">
                                    Browse Gigs
                                </button>
                            </div>
                        ` : ''}
                        <div class="bg-purple-50 p-8 rounded-xl shadow-lg flex flex-col items-center justify-center text-center border border-purple-200">
                            <h3 class="text-xl font-bold text-purple-700 mb-3">Your Orders</h3>
                            <p class="text-gray-600 mb-6">View your current and past orders.</p>
                            <button id="my-orders-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg glow-button">
                                View Orders
                            </button>
                        </div>
                    </div>
                </div>
            `;

            if (currentUser.user_type === 'freelancer') {
                document.getElementById('create-gig-btn').onclick = () => navigateTo('createGig');
            }
            if (currentUser.user_type === 'buyer') {
                document.getElementById('browse-gigs-btn').onclick = () => navigateTo('gigList');
            }
            document.getElementById('my-orders-btn').onclick = () => navigateTo('myOrders');
        }

        async function renderCreateGig() {
            if (!currentUser || currentUser.user_type !== 'freelancer') {
                showMessage('You must be a freelancer to create a gig.', 'error');
                navigateTo('dashboard');
                return;
            }

            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg border border-indigo-200">
                    <h2 class="text-3xl font-bold text-center text-indigo-700 mb-8">Create a New Gig</h2>
                    <form id="create-gig-form" class="space-y-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="title">Gig Title</label>
                            <input type="text" id="title" class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-800 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="description">Description</label>
                            <textarea id="description" class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-800 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200 h-32 resize-y"></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="category">Category</label>
                            <select id="category" class="block appearance-none w-full bg-white border border-gray-300 text-gray-800 py-3 px-4 pr-8 rounded-lg shadow-sm leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200" required>
                                <!-- Categories will be loaded here -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="price">Price ($)</label>
                            <input type="number" id="price" class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-800 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200" min="0.01" step="0.01" required>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg glow-button">Create Gig</button>
                    </form>
                </div>
            `;

            const categorySelect = document.getElementById('category');
            try {
                const categories = await fetchAPI('/categories');
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.name;
                    option.textContent = cat.name;
                    categorySelect.appendChild(option);
                });
            } catch (error) {
                // Error handled by fetchAPI
            }

            document.getElementById('create-gig-form').onsubmit = async (e) => {
                e.preventDefault();
                const title = document.getElementById('title').value;
                const description = document.getElementById('description').value;
                const category = document.getElementById('category').value;
                const price = parseFloat(document.getElementById('price').value);

                if (!title || !description || !category || isNaN(price) || price <= 0) {
                    showMessage('Please fill in all fields correctly.', 'error');
                    return;
                }

                try {
                    await fetchAPI('/gigs', 'POST', {
                        user_id: currentUser.user_id,
                        title,
                        description,
                        category,
                        price
                    });
                    showMessage('Gig created successfully!', 'success');
                    navigateTo('dashboard');
                } catch (error) {
                    // Error handled by fetchAPI
                }
            };
        }

        async function renderGigList() {
            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = `<h2 class="text-3xl font-bold text-center text-indigo-700 mb-6">Available Gigs</h2><div id="gigs-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>`;
            const gigsContainer = document.getElementById('gigs-container');

            try {
                const gigs = await fetchAPI('/gigs');
                if (gigs.length === 0) {
                    gigsContainer.innerHTML = '<div class="col-span-full text-center text-gray-600 py-8 text-lg bg-white rounded-xl shadow-lg border border-gray-200">No gigs available yet. Be the first to create one!</div>';
                    return;
                }

                gigs.forEach(gig => {
                    const gigCard = document.createElement('div');
                    gigCard.className = 'bg-white rounded-xl shadow-xl overflow-hidden transition duration-300 ease-in-out transform hover:scale-105 hover:shadow-2xl border border-indigo-100';
                    gigCard.innerHTML = `
                        <div class="p-6 flex flex-col h-full">
                            <h3 class="text-2xl font-bold text-indigo-800 mb-2">${gig.title}</h3>
                            <p class="text-sm text-indigo-600 font-semibold mb-3">${gig.category}</p>
                            <p class="text-gray-700 text-base mb-4 flex-grow line-clamp-4">${gig.description}</p>
                            <div class="flex justify-between items-center mt-auto pt-4 border-t border-gray-100">
                                <span class="text-green-600 font-bold text-xl">$${gig.price.toFixed(2)}</span>
                                <button class="view-details-btn bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg glow-button">
                                    View Details
                                </button>
                            </div>
                        </div>
                    `;
                    gigCard.querySelector('.view-details-btn').onclick = () => navigateTo('gigDetail', gig);
                    gigsContainer.appendChild(gigCard);
                });
            } catch (error) {
                gigsContainer.innerHTML = `<div class="col-span-full text-center text-red-600 py-8 text-lg bg-white rounded-xl shadow-lg border border-red-200">Failed to load gigs.</div>`;
            }
        }

        async function renderGigDetail() {
            if (!selectedGig) {
                navigateTo('gigList');
                return;
            }

            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-3xl border border-indigo-200">
                    <h2 class="text-4xl font-extrabold text-indigo-700 mb-4">${selectedGig.title}</h2>
                    <p class="text-lg text-gray-700 mb-2">
                        <span class="font-semibold text-indigo-600">Category:</span> ${selectedGig.category}
                    </p>
                    <p class="text-lg text-gray-700 mb-4">
                        <span class="font-semibold text-indigo-600">Freelancer:</span> <span id="freelancer-name" class="text-indigo-900 font-medium">Loading...</span>
                    </p>
                    <p class="text-gray-800 text-lg mb-6 leading-relaxed">
                        <span class="font-semibold text-indigo-600">Description:</span><br> ${selectedGig.description}
                    </p>
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-8 bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                        <span class="text-green-700 font-bold text-3xl mb-4 sm:mb-0">$${selectedGig.price.toFixed(2)}</span>
                        ${currentUser && currentUser.user_type === 'buyer' && currentUser.user_id !== selectedGig.user_id ? `
                            <button id="order-gig-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg glow-button">
                                Order This Gig
                            </button>
                        ` : `
                            <span class="text-gray-500 italic">
                                ${currentUser && currentUser.user_id === selectedGig.user_id ? 'This is your gig.' : 'Log in as a buyer to order.'}
                            </span>
                        `}
                    </div>
                    <button onclick="navigateTo('gigList')" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg glow-button">Back to Gigs</button>
                </div>
            `;

            try {
                const freelancer = await fetchAPI(`/users/${selectedGig.user_id}`);
                document.getElementById('freelancer-name').textContent = freelancer.name;
            } catch (error) {
                document.getElementById('freelancer-name').textContent = 'Error loading freelancer name';
            }

            if (currentUser && currentUser.user_type === 'buyer' && currentUser.user_id !== selectedGig.user_id) {
                document.getElementById('order-gig-btn').onclick = async () => {
                    if (!confirm('Are you sure you want to order this gig?')) return;
                    try {
                        const orderData = await fetchAPI('/orders', 'POST', {
                            gig_id: selectedGig.id,
                            buyer_id: currentUser.user_id,
                            freelancer_id: selectedGig.user_id // The gig creator is the freelancer
                        });
                        showMessage(`Order created successfully! Order ID: ${orderData.order_id}`, 'success');
                        navigateTo('myOrders');
                    } catch (error) {
                        // Error handled by fetchAPI
                    }
                };
            }
        }

        async function renderMyOrders() {
            if (!currentUser) {
                navigateTo('auth');
                return;
            }

            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = `<h2 class="text-3xl font-bold text-center text-indigo-700 mb-6">Your Orders</h2><div id="orders-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>`;
            const ordersContainer = document.getElementById('orders-container');

            try {
                const orders = await fetchAPI(`/orders?user_id=${currentUser.user_id}&user_type=${currentUser.user_type}`);

                if (orders.length === 0) {
                    ordersContainer.innerHTML = '<div class="col-span-full text-center text-gray-600 py-8 text-lg bg-white rounded-xl shadow-lg border border-gray-200">You have no orders yet.</div>';
                    return;
                }

                for (const order of orders) {
                    const gig = await fetchAPI(`/gigs/${order.gig_id}`); // Fetch gig details for each order
                    const otherPartyId = currentUser.user_type === 'buyer' ? order.freelancer_id : order.buyer_id;
                    const otherParty = await fetchAPI(`/users/${otherPartyId}`); // Fetch name of the other party

                    const orderCard = document.createElement('div');
                    orderCard.className = 'bg-white rounded-xl shadow-xl overflow-hidden border border-purple-100 flex flex-col';
                    orderCard.innerHTML = `
                        <div class="p-6 flex-grow">
                            <h3 class="text-2xl font-bold text-purple-800 mb-2">Order for: ${gig.title}</h3>
                            <p class="text-gray-700 text-sm mb-2"><strong>Order ID:</strong> ${order.id}</p>
                            <p class="text-gray-700 text-sm mb-2"><strong>Role:</strong> ${currentUser.user_type === 'buyer' ? 'Buyer' : 'Freelancer'}</p>
                            <p class="text-gray-700 text-sm mb-2"><strong>${currentUser.user_type === 'buyer' ? 'Freelancer' : 'Buyer'}:</strong> ${otherParty.name}</p>
                            <p class="text-gray-700 text-sm mb-2"><strong>Status:</strong> <span class="capitalize font-semibold text-purple-600">${order.status.replace(/_/g, ' ')}</span></p>
                            <p class="text-gray-700 text-sm mb-2"><strong>Ordered On:</strong> ${order.order_date}</p>
                            ${order.delivery_date ? `<p class="text-gray-700 text-sm mb-2"><strong>Delivered On:</strong> ${order.delivery_date}</p>` : ''}
                            <p class="text-gray-700 text-sm"><strong>Price:</strong> $${gig.price.toFixed(2)}</p>
                        </div>
                        <div class="p-6 border-t border-purple-100 flex flex-wrap gap-3 justify-center sm:justify-end">
                            <button data-order-id="${order.id}" class="view-messages-btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg glow-button">
                                View Messages
                            </button>
                            ${currentUser.user_type === 'freelancer' && order.status === 'in_progress' ? `
                                <button data-order-id="${order.id}" class="mark-completed-btn bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg glow-button">
                                    Mark Completed
                                </button>
                            ` : ''}
                            ${currentUser.user_type === 'buyer' && order.status === 'completed' ? `
                                <button data-order-id="${order.id}" class="leave-review-btn bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded-lg glow-button">
                                    Leave Review
                                </button>
                            ` : ''}
                        </div>
                    `;
                    ordersContainer.appendChild(orderCard);
                }

                document.querySelectorAll('.view-messages-btn').forEach(button => {
                    button.onclick = () => {
                        const orderId = parseInt(button.dataset.orderId);
                        // Find the selected order object from the fetched orders array
                        selectedOrder = orders.find(o => o.id === orderId);
                        if (selectedOrder) {
                            navigateTo('messages', selectedOrder);
                        } else {
                            showMessage('Order not found.', 'error');
                        }
                    };
                });

                document.querySelectorAll('.mark-completed-btn').forEach(button => {
                    button.onclick = async () => {
                        if (!confirm('Are you sure you want to mark this order as completed?')) return;
                        const orderId = parseInt(button.dataset.orderId);
                        try {
                            await fetchAPI(`/orders/${orderId}/status`, 'PUT', { status: 'completed' });
                            showMessage('Order marked as completed!', 'success');
                            renderMyOrders(); // Re-render to update status
                        } catch (error) {
                            // Error handled by fetchAPI
                        }
                    };
                });

                document.querySelectorAll('.leave-review-btn').forEach(button => {
                    button.onclick = () => {
                        const orderId = parseInt(button.dataset.orderId);
                        selectedOrder = orders.find(o => o.id === orderId);
                        if (selectedOrder) {
                            navigateTo('reviews', selectedOrder);
                        } else {
                            showMessage('Order not found.', 'error');
                        }
                    };
                });

            } catch (error) {
                ordersContainer.innerHTML = `<div class="col-span-full text-center text-red-600 py-8 text-lg bg-white rounded-xl shadow-lg border border-red-200">Failed to load orders.</div>`;
            }
        }

        async function renderMessages() {
            if (!currentUser || !selectedOrder) {
                showMessage('No order selected for messages.', 'error');
                navigateTo('myOrders');
                return;
            }

            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-3xl h-full flex flex-col border border-indigo-200" id="messages-content-area">
                    <h2 class="text-3xl font-bold text-center text-indigo-700 mb-6">Messages for Order #${selectedOrder.id}</h2>
                    <div id="chat-messages-container" class="flex-grow overflow-y-auto p-4 bg-gray-50 rounded-lg border border-gray-200 mb-4">
                        <!-- Messages will be loaded here -->
                    </div>
                    <form id="send-message-form" class="flex gap-2">
                        <input type="text" id="message-input" placeholder="Type your message..." class="flex-grow shadow-sm appearance-none border border-gray-300 rounded-lg py-3 px-4 text-gray-800 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200" required>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg glow-button">Send</button>
                    </form>
                    <button onclick="navigateTo('myOrders')" class="mt-4 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg glow-button">Back to Orders</button>
                </div>
            `;

            const chatMessagesContainer = document.getElementById('chat-messages-container');
            const messageInput = document.getElementById('message-input');
            const sendMessageForm = document.getElementById('send-message-form');

            // NEW: Join the Socket.IO room for this order
            if (socket && socket.connected) {
                socket.emit('join_order_room', { order_id: selectedOrder.id });
                console.log(`Frontend: Client joined order room: ${selectedOrder.id}`); // Added more specific log
            } else {
                console.warn("Frontend: Socket.IO not connected, messages might not be real-time.");
                // Optionally, try to reconnect or show a message
            }

            // Function to fetch and display historical messages
            const loadHistoricalMessages = async () => {
                try {
                    const messages = await fetchAPI(`/messages?order_id=${selectedOrder.id}`);
                    chatMessagesContainer.innerHTML = ''; // Clear previous messages
                    if (messages.length === 0) {
                        chatMessagesContainer.innerHTML = '<p class="text-center text-gray-500">No messages yet. Start the conversation!</p>';
                    } else {
                        messages.forEach(msg => {
                            displayNewMessageInChat(msg);
                        });
                    }
                    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Scroll to bottom after loading history
                } catch (error) {
                    chatMessagesContainer.innerHTML = `<p class="text-center text-red-500">Failed to load messages: ${error.message}</p>`;
                }
            };

            // Call to load historical messages when view is rendered
            await loadHistoricalMessages();

            // Handle sending new messages
            sendMessageForm.onsubmit = async (e) => {
                e.preventDefault();
                const messageText = messageInput.value.trim();
                if (messageText) {
                    try {
                        const receiverId = currentUser.user_type === 'buyer' ? selectedOrder.freelancer_id : selectedOrder.buyer_id;
                        // The API call to save the message to DB. Backend will then emit SocketIO event.
                        await fetchAPI('/messages', 'POST', {
                            order_id: selectedOrder.id,
                            sender_id: currentUser.user_id,
                            receiver_id: receiverId,
                            message: messageText
                        });
                        messageInput.value = ''; // Clear input field
                        // Message will be displayed via WebSocket 'new_message' event
                    } catch (error) {
                        // Error handled by fetchAPI
                    }
                }
            };
        }

        async function renderReviews() {
            if (!currentUser || !selectedOrder) {
                showMessage('No order selected for reviews.', 'error');
                navigateTo('myOrders');
                return;
            }

            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-3xl border border-indigo-200">
                    <h2 class="text-3xl font-bold text-center text-indigo-700 mb-6">Reviews for Order #${selectedOrder.id}</h2>
                    
                    ${currentUser.user_type === 'buyer' ? `
                        <div class="bg-gray-50 p-6 rounded-lg mb-6 border border-gray-200">
                            <h3 class="text-xl font-bold text-indigo-700 mb-4">Leave a Review</h3>
                            <form id="review-form" class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 text-sm font-medium mb-2" for="rating">Rating (1-5)</label>
                                    <input type="number" id="rating" class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-800 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200" min="1" max="5" required>
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-medium mb-2" for="comment">Comment (Optional)</label>
                                    <textarea id="comment" class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-800 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200 h-24 resize-y"></textarea>
                                </div>
                                <button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg glow-button">Submit Review</button>
                            </form>
                        </div>
                    ` : '<p class="text-center text-gray-600 mb-6">Only buyers can leave reviews for completed orders.</p>'}

                    <h3 class="text-xl font-bold text-indigo-700 mb-4">Past Reviews for this Order</h3>
                    <div id="reviews-list" class="space-y-4">
                        <!-- Reviews will be loaded here -->
                    </div>
                    <button onclick="navigateTo('myOrders')" class="mt-6 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg glow-button">Back to Orders</button>
                </div>
            `;

            const reviewsListContainer = document.getElementById('reviews-list');

            // Load and display existing reviews
            const loadReviews = async () => {
                try {
                    const reviews = await fetchAPI(`/reviews?order_id=${selectedOrder.id}`);
                    reviewsListContainer.innerHTML = ''; // Clear previous reviews
                    if (reviews.length === 0) {
                        reviewsListContainer.innerHTML = '<p class="text-center text-gray-500">No reviews for this order yet.</p>';
                    } else {
                        for (const review of reviews) {
                            const reviewer = await fetchAPI(`/users/${review.reviewer_id}`);
                            const reviewCard = document.createElement('div');
                            reviewCard.className = 'bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200';
                            reviewCard.innerHTML = `
                                <p class="font-bold text-gray-800">${reviewer.name} - Rating: ${''.repeat(review.rating)}</p>
                                <p class="text-gray-600 text-sm">${review.comment || 'No comment provided.'}</p>
                                <p class="text-gray-500 text-xs mt-1">Reviewed on: ${new Date(review.review_date).toLocaleDateString()}</p>
                            `;
                            reviewsListContainer.appendChild(reviewCard);
                        }
                    }
                } catch (error) {
                    reviewsListContainer.innerHTML = `<p class="text-center text-red-500">Failed to load reviews: ${error.message}</p>`;
                }
            };

            await loadReviews();

            if (currentUser.user_type === 'buyer') {
                const reviewForm = document.getElementById('review-form');
                if (reviewForm) {
                    reviewForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const rating = parseInt(document.getElementById('rating').value);
                        const comment = document.getElementById('comment').value.trim();

                        if (isNaN(rating) || rating < 1 || rating > 5) {
                            showMessage('Please provide a rating between 1 and 5.', 'error');
                            return;
                        }

                        try {
                            await fetchAPI('/reviews', 'POST', {
                                order_id: selectedOrder.id,
                                reviewer_id: currentUser.user_id,
                                rating: rating,
                                comment: comment
                            });
                            showMessage('Review submitted successfully!', 'success');
                            await loadReviews(); // Reload reviews to show the new one
                            reviewForm.reset(); // Clear the form
                        } catch (error) {
                            // Error handled by fetchAPI
                        }
                    };
                }
            }
        }

        // --- Core Application Logic (Init) ---

        // NEW: Function to display a new message in the chat UI
        function displayNewMessageInChat(message) {
            const chatMessagesContainer = document.getElementById('chat-messages-container');
            if (!chatMessagesContainer) {
                console.error("Frontend: Chat messages container not found!"); // Added more specific log
                return;
            }

            console.log("Frontend: Displaying new message in chat:", message); // Added more specific log

            const messageElement = document.createElement('div');
            // Add class based on who sent the message for different styling (e.g., right vs left)
            messageElement.classList.add('message-item');
            if (currentUser && message.sender_id === currentUser.user_id) { // Added currentUser check
                messageElement.classList.add('sent-by-me');
            }

            // Format timestamp (if sent_at is a full datetime string)
            let sentTime = '';
            try {
                sentTime = new Date(message.sent_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                console.warn("Frontend: Could not parse message.sent_at:", message.sent_at, e); // Warn on parse error
                sentTime = ''; // Fallback if date parsing fails
            }

            messageElement.innerHTML = `
                <div class="font-semibold text-sm mb-1">${currentUser && message.sender_id === currentUser.user_id ? 'You' : `User ${message.sender_id}`} <span class="text-gray-500 text-xs">${sentTime}</span></div>
                <p class="text-gray-800">${message.message}</p>
            `;
            
            chatMessagesContainer.appendChild(messageElement);

            // Scroll to the bottom to show the latest message
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }


        // Load current user from localStorage on page load
        document.addEventListener('DOMContentLoaded', () => {
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                currentView = 'dashboard'; // Go to dashboard if already logged in
            }
            render();

            // NEW: Initialize Socket.IO connection when DOM is ready
            // The socket object is already declared globally at the top
            // If you are getting 'websocket error' or 'xhr poll error', the primary issue is likely
            // your backend's Gunicorn configuration (it needs --worker-class eventlet)
            // and potentially a missing or misconfigured REDIS_URL environment variable on Render.com.
            // These options are already included for robustness, but the server must support the connection.
            socket = io(SOCKET_IO_SERVER_URL, {
                transports: ['websocket', 'polling'], // Explicitly prefer websocket, then polling
                withCredentials: true, // Important for CORS and session/cookie handling if any
                forceNew: true, // Force a new connection instead of reusing a cached one
                // Optional: If you suspect a version mismatch with an older Flask-SocketIO, you might try:
                // allowEIO3: true,
            });

            // Added connect_error listener for debugging
            socket.on('connect_error', (error) => {
                console.error("Frontend: Socket.IO Connection Error:", error);
                // More specific messages based on the error type
                if (error.message.includes('websocket error') || error.message.includes('xhr poll error')) {
                    showMessage(`WebSocket connection failed. This usually means the backend Socket.IO server is not reachable or incorrectly configured. Please verify your backend's Gunicorn start command on Render.com (--worker-class eventlet) and ensure any required Redis service (REDIS_URL) is properly set up.`, 'error');
                } else if (error.message.includes('timeout')) {
                     showMessage(`WebSocket connection timed out. The backend server might be slow to respond or unreachable.`, 'error');
                }
                else {
                    showMessage(`WebSocket connection error: ${error.message}. Real-time features may not work.`, 'error');
                }
            });

            socket.on('connect', () => {
                console.log('Frontend: Connected to WebSocket server. Socket ID:', socket.id); // Log socket ID
                // If we are already in a messages view when connected, join the room
                if (currentView === 'messages' && selectedOrder && selectedOrder.id) {
                    socket.emit('join_order_room', { order_id: selectedOrder.id });
                    console.log(`Frontend: Attempting to join order room: ${selectedOrder.id}`); // More specific log
                }
            });

            socket.on('disconnect', (reason) => {
                console.log('Frontend: Disconnected from WebSocket server. Reason:', reason); // Log disconnect reason
            });

            socket.on('status', (data) => {
                console.log('Frontend: Server status:', data.msg);
            });

            socket.on('new_message', (message) => {
                console.log('Frontend: New message received via WebSocket:', message);
                // Only display if the message belongs to the currently viewed order
                if (selectedOrder && message.order_id === selectedOrder.id) {
                    displayNewMessageInChat(message);
                } else {
                    console.log('Frontend: Message received for another order or no order selected.');
                }
            });

            // NEW: Add a 'leave_order_room_ack' event handler on the frontend as well
            // This is for when the user navigates away from the messages view.
            socket.on('leave_order_room_ack', (data) => {
                console.log('Frontend: Left order room:', data.order_id);
            });
        });
    </script>
</body>
</html>
